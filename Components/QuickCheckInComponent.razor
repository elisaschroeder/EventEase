@using EventEase.Models
@using EventEase.Models.Attendance
@using EventEase.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IAttendanceTrackingService AttendanceService
@inject IEventService EventService

<div class="card">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">
            <i class="fas fa-qrcode me-2"></i>
            Quick Check-In
        </h5>
    </div>
    <div class="card-body">
        @if (currentEvent != null)
        {
            <div class="mb-3">
                <h6 class="text-muted">Current Event</h6>
                <h5 class="text-primary">@currentEvent.Name</h5>
                <small class="text-muted">@currentEvent.Date.ToString("MMM dd, yyyy HH:mm")</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Search Attendee</label>
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Enter name or email..." 
                           @bind="searchTerm" @onkeypress="OnSearchKeyPress" />
                    <button class="btn btn-outline-primary" @onclick="SearchAttendees">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            @if (foundAttendees.Any())
            {
                <div class="mb-3">
                    <label class="form-label">Select Attendee</label>
                    <div class="list-group">
                        @foreach (var attendee in foundAttendees.Take(5))
                        {
                            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    @onclick="() => SelectAttendee(attendee)">
                                <div>
                                    <strong>@attendee.Name</strong>
                                    <br />
                                    <small class="text-muted">@attendee.Email - @attendee.Company</small>
                                </div>
                                <div>
                                    <span class="badge bg-@GetStatusBadgeColor(attendee.Status)">
                                        @attendee.Status.ToString()
                                    </span>
                                    @if (attendee.IsVip)
                                    {
                                        <span class="badge bg-warning text-dark ms-1">VIP</span>
                                    }
                                </div>
                            </button>
                        }
                    </div>
                </div>
            }
            
            @if (selectedAttendee != null)
            {
                <div class="alert alert-info">
                    <h6>Selected: @selectedAttendee.Name</h6>
                    <p class="mb-2">Status: <span class="badge bg-@GetStatusBadgeColor(selectedAttendee.Status)">@selectedAttendee.Status</span></p>
                    
                    <div class="d-flex gap-2">
                        @if (selectedAttendee.Status == AttendanceStatus.Registered)
                        {
                            <button class="btn btn-success btn-sm" @onclick="CheckIn">
                                <i class="fas fa-sign-in-alt me-1"></i>
                                Check In
                            </button>
                            <button class="btn btn-warning btn-sm" @onclick="MarkNoShow">
                                <i class="fas fa-user-times me-1"></i>
                                No Show
                            </button>
                        }
                        else if (selectedAttendee.Status == AttendanceStatus.CheckedIn)
                        {
                            <button class="btn btn-info btn-sm" @onclick="CheckOut">
                                <i class="fas fa-sign-out-alt me-1"></i>
                                Check Out
                            </button>
                        }
                        <button class="btn btn-outline-secondary btn-sm" @onclick="ClearSelection">
                            <i class="fas fa-times me-1"></i>
                            Clear
                        </button>
                    </div>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert alert-@statusMessageType alert-dismissible fade show">
                    @statusMessage
                    <button type="button" class="btn-close" @onclick="ClearMessage"></button>
                </div>
            }
        }
        else
        {
            <div class="text-center text-muted py-3">
                <i class="fas fa-calendar-times fa-2x mb-2"></i>
                <p>No current event found</p>
                <small>The quick check-in is available during event times</small>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public EventCallback OnAttendeeCheckedIn { get; set; }
    [Parameter] public EventCallback OnAttendeeCheckedOut { get; set; }
    
    private Event? currentEvent;
    private List<AttendeeRecord> foundAttendees = new();
    private AttendeeRecord? selectedAttendee;
    private string searchTerm = string.Empty;
    private string statusMessage = string.Empty;
    private string statusMessageType = "success";

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentEvent();
    }

    private async Task LoadCurrentEvent()
    {
        var events = await EventService.GetEventsAsync();
        var now = DateTime.Now;
        
        // Find event that's happening now (within 2 hours before and after start time)
        currentEvent = events.FirstOrDefault(e => 
            e.Date.Date == now.Date &&
            now >= e.Date.AddHours(-2) &&
            now <= e.Date.AddHours(6));
        
        // If no current event, find the next upcoming event
        if (currentEvent == null)
        {
            currentEvent = events.Where(e => e.Date >= now)
                                 .OrderBy(e => e.Date)
                                 .FirstOrDefault();
        }
    }

    private async Task OnSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchAttendees();
        }
    }

    private async Task SearchAttendees()
    {
        if (currentEvent == null || string.IsNullOrWhiteSpace(searchTerm))
        {
            foundAttendees.Clear();
            return;
        }

        var eventAttendees = await AttendanceService.GetEventAttendeesAsync(currentEvent.Id);
        var searchLower = searchTerm.ToLower();
        
        foundAttendees = eventAttendees.Where(a =>
            a.Name.ToLower().Contains(searchLower) ||
            a.Email.ToLower().Contains(searchLower) ||
            a.Company.ToLower().Contains(searchLower)
        ).ToList();
    }

    private void SelectAttendee(AttendeeRecord attendee)
    {
        selectedAttendee = attendee;
        foundAttendees.Clear();
        searchTerm = string.Empty;
    }

    private async Task CheckIn()
    {
        if (selectedAttendee == null || currentEvent == null) return;

        try
        {
            var request = new CheckInRequest
            {
                AttendeeId = selectedAttendee.Id,
                EventId = currentEvent.Id,
                Notes = "Quick check-in via attendance tracker"
            };

            await AttendanceService.CheckInAttendeeAsync(request);
            selectedAttendee.Status = AttendanceStatus.CheckedIn;
            selectedAttendee.CheckInTime = DateTime.Now;
            
            ShowMessage($"{selectedAttendee.Name} checked in successfully!", "success");
            await OnAttendeeCheckedIn.InvokeAsync();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error checking in: {ex.Message}", "danger");
        }
    }

    private async Task CheckOut()
    {
        if (selectedAttendee == null || currentEvent == null) return;

        try
        {
            var request = new CheckOutRequest
            {
                AttendeeId = selectedAttendee.Id,
                EventId = currentEvent.Id
            };

            await AttendanceService.CheckOutAttendeeAsync(request);
            selectedAttendee.Status = AttendanceStatus.CheckedOut;
            selectedAttendee.CheckOutTime = DateTime.Now;
            
            ShowMessage($"{selectedAttendee.Name} checked out successfully!", "success");
            await OnAttendeeCheckedOut.InvokeAsync();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error checking out: {ex.Message}", "danger");
        }
    }

    private async Task MarkNoShow()
    {
        if (selectedAttendee == null) return;

        try
        {
            await AttendanceService.MarkAsNoShowAsync(selectedAttendee.Id);
            selectedAttendee.Status = AttendanceStatus.NoShow;
            
            ShowMessage($"{selectedAttendee.Name} marked as no-show", "warning");
        }
        catch (Exception ex)
        {
            ShowMessage($"Error marking no-show: {ex.Message}", "danger");
        }
    }

    private void ClearSelection()
    {
        selectedAttendee = null;
        foundAttendees.Clear();
        searchTerm = string.Empty;
        ClearMessage();
    }

    private void ShowMessage(string message, string type)
    {
        statusMessage = message;
        statusMessageType = type;
    }

    private void ClearMessage()
    {
        statusMessage = string.Empty;
    }

    private string GetStatusBadgeColor(AttendanceStatus status)
    {
        return status switch
        {
            AttendanceStatus.Registered => "primary",
            AttendanceStatus.CheckedIn => "success",
            AttendanceStatus.CheckedOut => "info",
            AttendanceStatus.NoShow => "danger",
            AttendanceStatus.Cancelled => "warning",
            _ => "secondary"
        };
    }
}

<style>
    .list-group-item {
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
    }
    
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .badge {
        font-size: 0.7rem;
    }
</style>